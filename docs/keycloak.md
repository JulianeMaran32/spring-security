# Keycloak

## Configurando o Keycloak

1. Acesse o link [Keycloak](https://www.keycloak.org/)
2. Faça o [download](https://www.keycloak.org/downloads)
3. Tutorial do [OpenJDK](https://www.keycloak.org/getting-started/getting-started-zip)

## Utilizando o Postman

> Para melhor visualização dos campos preenchidos no Postman, foi utilizado o tipo HTTP

1. Gerar Token

```http request
POST /realms/eazybankdev/protocol/openid-connect/token HTTP/1.1
Host: localhost:8180
Content-Type: application/x-www-form-urlencoded
Content-Length: 139

client_id = eazybankapi &
client_secret = ioabAQA6hsouVtxk1HkYiXZHN168TNrv &
scope = openid%20email%20profile%20address &
grant_type = client_credentials
```

* Exemplo de Response

```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0Um5LUnpTZGlaYVpTeVNQZExNMUhvYlFXUW9UZXBRMGRPX0tZYTdFd3hJIn0.eyJleHAiOjE3MTA2NzY3MzcsImlhdCI6MTcxMDY3NjQzNywianRpIjoiZTlmZjk4ZGYtNjczMC00ZjJmLWIxYzQtZTZiODlmNWQ4YTQ1IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MTgwL3JlYWxtcy9lYXp5YmFua2RldiIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiJjNzYwZDNkZC0yNmNkLTQ5MTctODQ1OS0wMWE3OGZiYzFjMDgiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJlYXp5YmFua2FwaSIsImFjciI6IjEiLCJhbGxvd2VkLW9yaWdpbnMiOlsiLyoiXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iLCJBRE1JTiIsIlVTRVIiLCJkZWZhdWx0LXJvbGVzLWVhenliYW5rZGV2Il19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgYWRkcmVzcyBwcm9maWxlIGVtYWlsIiwiYWRkcmVzcyI6e30sImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwiY2xpZW50SG9zdCI6IjA6MDowOjA6MDowOjA6MSIsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1lYXp5YmFua2FwaSIsImNsaWVudEFkZHJlc3MiOiIwOjA6MDowOjA6MDowOjEiLCJjbGllbnRfaWQiOiJlYXp5YmFua2FwaSJ9.Bn5WYfFd_KuZSLGhJwywQlT1phIma1wxdZ0s-FaunlhdhEgfHL94QOj8oK5L9L4iCWnnsB6FDRnZRcvbPoUhsGhsfhrbPYNIo08izKKofLaJIuIlnAQeUp5OyZFN4fS7F1ziZvwxoJKk3Ul-QYGKmq70yAD7LWVoQc7L8o3qgMG9wupIlRL6cRyNyBb3oDyhRRp8pKZCe6vsOvz4wCkJugqoR1kyKrIExHwBaJyUmCEMZ_P0lP6cOIHEHPY-jBGG2UPr3_wSUEyRjWbTsMJFxxa3FBnVFuo0ET-KhE7ZCyeQQJmidEwfI2awn_XiBYwC_s9MmNiY9_xCjuaV2L0dJg",
  "expires_in": 300,
  "refresh_expires_in": 0,
  "token_type": "Bearer",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0Um5LUnpTZGlaYVpTeVNQZExNMUhvYlFXUW9UZXBRMGRPX0tZYTdFd3hJIn0.eyJleHAiOjE3MTA2NzY3MzcsImlhdCI6MTcxMDY3NjQzNywiYXV0aF90aW1lIjowLCJqdGkiOiJjY2RmZThhOC0zYjEwLTQ5ZWItOTBhYy1jMGE4YjM3YTNkMmEiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgxODAvcmVhbG1zL2VhenliYW5rZGV2IiwiYXVkIjoiZWF6eWJhbmthcGkiLCJzdWIiOiJjNzYwZDNkZC0yNmNkLTQ5MTctODQ1OS0wMWE3OGZiYzFjMDgiLCJ0eXAiOiJJRCIsImF6cCI6ImVhenliYW5rYXBpIiwiYXRfaGFzaCI6ImE1bVZHZVctRzlIcnBkTzU5c2dzMWciLCJhY3IiOiIxIiwiYWRkcmVzcyI6e30sImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwiY2xpZW50SG9zdCI6IjA6MDowOjA6MDowOjA6MSIsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1lYXp5YmFua2FwaSIsImNsaWVudEFkZHJlc3MiOiIwOjA6MDowOjA6MDowOjEiLCJjbGllbnRfaWQiOiJlYXp5YmFua2FwaSJ9.Cq6y27_5AufbX9cdI77JMJkQ6Dgcu1eDJDC9r3p5zi9Uc7Mn_EnkeQ4yhr7YMJNUUiZyxbPIsHizyqJh6bXKYCM7cKpOLSlxaxQG-ncbbXtwTiYxWX_ZOEH964sFs-arat3aC91oEZKDQN5mYDfV9dMmGo6JHnWXqvEs5tn30-oLiXRL0T9joUfb8De_B5feJxdI9CREmwUhLVL9w_LiTQIHjZJY4GAiOAFAGHkGG9O1NE55kHsCHX_IRuAifqLxEmdwIWZtLGprhqPtRUUdQlRa4SDgOhZzSbwpJdZ3n2T0EALc3ZPNKbi6_fPyi-snbu4mB0e_KocQbPkMiL5bvQ",
  "not-before-policy": 0,
  "scope": "openid address profile email"
}
```

2. Para gerar o `code` deve inserir a URL abaixo no navegador

```http request
GET /realms/eazybankdev/protocol/openid-connect/auth?client_id=eazybankclient&response_type=code&scope=openid&
    redirect_uri=http://localhost:7080/sample&state=qualquercoisaaqui HTTP/1.1
Host: localhost:8180
```

3. Entrar com as credenciais do Usuário Happy
4. Na barra de navegação irá aparecer o `code`

Exemplo de URL gerada:

```url
http://localhost:7080/sample?state=qualquercoisaaqui&session_state=d01f22f6-2a48-4ea3-b867-ad7c46dd76f8&iss=http%3A%2F%2Flocalhost%3A8180%2Frealms%2Feazybankdev&code=4f78cd7a-34cd-4a05-bad1-a2cfe26fdf41.d01f22f6-2a48-4ea3-b867-ad7c46dd76f8.75b3dbcd-6dff-4ff4-b12b-ca6c1c46ba7b
```

### Inserir o `code` gerado anteriormente na request abaixo

```http request
POST /realms/eazybankdev/protocol/openid-connect/token HTTP/1.1
Host: localhost:8180
Content-Type: application/x-www-form-urlencoded
Content-Length: 282

client_id = eazybankclient &
client_secret = gs83QOcrcPh6djyPmwC6U8ua4El07HAh &
grant_type = authorization_code &
code = 4f78cd7a-34cd-4a05-bad1-a2cfe26fdf41.d01f22f6-2a48-4ea3-b867-ad7c46dd76f8.75b3dbcd-6dff-4ff4-b12b-ca6c1c46ba7b &
redirect_uri = http%3A%2F%2Flocalhost%3A7080%2Fsample &
scope = openid
```

* Exemplo de Response

```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0Um5LUnpTZGlaYVpTeVNQZExNMUhvYlFXUW9UZXBRMGRPX0tZYTdFd3hJIn0.eyJleHAiOjE3MTA2NzYxODksImlhdCI6MTcxMDY3NTg4OSwiYXV0aF90aW1lIjoxNzEwNjc1ODY1LCJqdGkiOiI5M2M0NGRlZS1jOTJhLTQyYmMtYjJmMS0wODRiNDkyOWY4MTAiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgxODAvcmVhbG1zL2VhenliYW5rZGV2IiwiYXVkIjoiYWNjb3VudCIsInN1YiI6ImI3ODMxZTU5LTNjOTQtNDg2MS1hZjQxLTkyZjA1ZDc1ZjBkMSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImVhenliYW5rY2xpZW50Iiwic2Vzc2lvbl9zdGF0ZSI6ImQwMWYyMmY2LTJhNDgtNGVhMy1iODY3LWFkN2M0NmRkNzZmOCIsImFjciI6IjEiLCJhbGxvd2VkLW9yaWdpbnMiOlsiLyoiXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iLCJBRE1JTiIsIlVTRVIiLCJkZWZhdWx0LXJvbGVzLWVhenliYW5rZGV2Il19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsInNpZCI6ImQwMWYyMmY2LTJhNDgtNGVhMy1iODY3LWFkN2M0NmRkNzZmOCIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiSGFwcHkgRXhhbXBsZSIsInByZWZlcnJlZF91c2VybmFtZSI6ImhhcHB5QGV4YW1wbGUuY29tIiwiZ2l2ZW5fbmFtZSI6IkhhcHB5IiwiZmFtaWx5X25hbWUiOiJFeGFtcGxlIiwiZW1haWwiOiJoYXBweUBleGFtcGxlLmNvbSJ9.NEp55MBvj67tUAW01-RIaQnavFaGPK5RBrRFpggZewdrhBxZdtv5lfAgxyLIK3xYo5Z5EBUAlwl-oG88rKeH4FV-RTtNX93KWBENZixT1SIwoIlRCm5AtylIh4JObLLr2oHpjZBCgC35h0_xabbzylrEynukFJExXG43b6J2jTRr5Fav0l8SDWIaJwkmUJqvwNo8QMyROKeGLsGrr-YzIi_X3asDxtT4BUdx2slbByJrVcq5j2sUcOjCylbYPxeUXMzH07ZkJL9zJ_ZsOWI1lUbGoNqUTr4Y9KtlHISTHe3BHYFqb-MNPAxdO6wqRepvm1nPD88aGI9ha_fQgsVhhg",
  "expires_in": 300,
  "refresh_expires_in": 1776,
  "refresh_token": "eyJhbGciOiJIUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1MmNiYjZkZS1mYjEwLTQzMzMtYjg4Zi0xNWU2MjJjMTc2MmQifQ.eyJleHAiOjE3MTA2Nzc2NjUsImlhdCI6MTcxMDY3NTg4OSwianRpIjoiYzYxZDQ5ZTQtOTE0ZS00Y2VkLTk4NTUtNDE4OTgyMTEzNDI4IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MTgwL3JlYWxtcy9lYXp5YmFua2RldiIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODE4MC9yZWFsbXMvZWF6eWJhbmtkZXYiLCJzdWIiOiJiNzgzMWU1OS0zYzk0LTQ4NjEtYWY0MS05MmYwNWQ3NWYwZDEiLCJ0eXAiOiJSZWZyZXNoIiwiYXpwIjoiZWF6eWJhbmtjbGllbnQiLCJzZXNzaW9uX3N0YXRlIjoiZDAxZjIyZjYtMmE0OC00ZWEzLWI4NjctYWQ3YzQ2ZGQ3NmY4Iiwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsInNpZCI6ImQwMWYyMmY2LTJhNDgtNGVhMy1iODY3LWFkN2M0NmRkNzZmOCJ9.di29K1QHCiEEqi4ttNJXBC0aiyQL-_hB_Ts7oRXilslzexTbKcFfw5xXiukg4ipt5WALpgyTZIfc6eTUEjSmKg",
  "token_type": "Bearer",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0Um5LUnpTZGlaYVpTeVNQZExNMUhvYlFXUW9UZXBRMGRPX0tZYTdFd3hJIn0.eyJleHAiOjE3MTA2NzYxODksImlhdCI6MTcxMDY3NTg4OSwiYXV0aF90aW1lIjoxNzEwNjc1ODY1LCJqdGkiOiJjZDM5NDIxYy1lMjBjLTQ2MjAtYjBkYi03ZmFkOTVhZDE0ZDUiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgxODAvcmVhbG1zL2VhenliYW5rZGV2IiwiYXVkIjoiZWF6eWJhbmtjbGllbnQiLCJzdWIiOiJiNzgzMWU1OS0zYzk0LTQ4NjEtYWY0MS05MmYwNWQ3NWYwZDEiLCJ0eXAiOiJJRCIsImF6cCI6ImVhenliYW5rY2xpZW50Iiwic2Vzc2lvbl9zdGF0ZSI6ImQwMWYyMmY2LTJhNDgtNGVhMy1iODY3LWFkN2M0NmRkNzZmOCIsImF0X2hhc2giOiJfU2l0T1lrbjE0ZEtBejloVXRJNkpnIiwiYWNyIjoiMSIsInNpZCI6ImQwMWYyMmY2LTJhNDgtNGVhMy1iODY3LWFkN2M0NmRkNzZmOCIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiSGFwcHkgRXhhbXBsZSIsInByZWZlcnJlZF91c2VybmFtZSI6ImhhcHB5QGV4YW1wbGUuY29tIiwiZ2l2ZW5fbmFtZSI6IkhhcHB5IiwiZmFtaWx5X25hbWUiOiJFeGFtcGxlIiwiZW1haWwiOiJoYXBweUBleGFtcGxlLmNvbSJ9.eDqhzlRFIO32scp8JR3xBRJAbh2PktLhABvDbELGURU98Dj8UiHMjVYg0WdXxJkMXAZmgwHVhvWAKuVkdTwqUOJLcJxcfIt5vMn54sHZsj5jCz9OVaa6Qn0VSOIYWDXKjiTwBZklD-RVBMtvZL7OWJXKSRddmjtEVwCk6ubm-1EYS8tt_6fGkyA_GOKQ97EfvvdisLtZPJLcY9MeHee8Yuu6B8PbPkhcF04XNTqkLar5O8YbDOCEkKp3qHuLL2v4fMleeqpEVnl6_yWzstma443lEKCt7jRSSJCEJgVk5UrIs_E3fcsc033HsuVpYNpEPhMRO6CO9QtMrXhvBrXr9g",
  "not-before-policy": 0,
  "session_state": "d01f22f6-2a48-4ea3-b867-ad7c46dd76f8",
  "scope": "openid profile email"
}
```

### Request: Utilizando o token gerado anteriormente para o Usuário Happy acessar o endpoint /myCards

```http request
GET /myCards?email=happy@example.com HTTP/1.1
Host: localhost:8585
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0Um5LUnpTZGlaYVpTeVNQZExNMUhvYlFXUW9UZXBRMGRPX0tZYTdFd3hJIn0.eyJleHAiOjE3MTA2Mzk5NzksImlhdCI6MTcxMDYzOTY3OSwiYXV0aF90aW1lIjoxNzEwNjM4NzkwLCJqdGkiOiJlNWQ3NjA4Yy02YTNmLTQ4NTAtODJlMy03ZWQzMDRlMjlmOGEiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgxODAvcmVhbG1zL2VhenliYW5rZGV2IiwiYXVkIjoiYWNjb3VudCIsInN1YiI6ImI3ODMxZTU5LTNjOTQtNDg2MS1hZjQxLTkyZjA1ZDc1ZjBkMSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImVhenliYW5rY2xpZW50Iiwic2Vzc2lvbl9zdGF0ZSI6Ijg4ZjcxNzRlLWZkNjYtNDgxZi05MWE1LTAwNGU3ZmU5ZjQ3YSIsImFjciI6IjAiLCJhbGxvd2VkLW9yaWdpbnMiOlsiLyoiXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iLCJBRE1JTiIsIlVTRVIiLCJkZWZhdWx0LXJvbGVzLWVhenliYW5rZGV2Il19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsInNpZCI6Ijg4ZjcxNzRlLWZkNjYtNDgxZi05MWE1LTAwNGU3ZmU5ZjQ3YSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiSGFwcHkgRXhhbXBsZSIsInByZWZlcnJlZF91c2VybmFtZSI6ImhhcHB5QGV4YW1wbGUuY29tIiwiZ2l2ZW5fbmFtZSI6IkhhcHB5IiwiZmFtaWx5X25hbWUiOiJFeGFtcGxlIiwiZW1haWwiOiJoYXBweUBleGFtcGxlLmNvbSJ9.HqSb_q3zVZP8JMQttBgnNTcmtc2E97lNcWlxzmSs8dR19WGzPhh__dTlvcJPKl8w0inMu1rHB7u3RrIs2QDI8kVhEz2081Sarge5fQwx_jcwh96q3r_iKDM8TtGR9L2s1CKBdjQr70-5uODMtwe9OLuF7ooMyxgWbdWJvdhPnlK6RovcHZ3TL_u_Or3ETskVW_SpwoHUETFWyqRn4HxnC5tJjX1Jy-j7LHYA0BLeHK3kDaStO7DrQOjfbZ6zsKj9Z6om_FzkgN_yKcJSWAoZYdiV9MMxAMzgzZKloUOvBAiZ2RgHzlzonjfYvoUIkHovAjwpcUdiB4gvRxw42PE-5Q
```

### Response

```json

```

## Referências:

- [It's Time for OAuth 2.1](https://aaronparecki.com/2019/12/12/21/its-time-for-oauth-2-dot-1)